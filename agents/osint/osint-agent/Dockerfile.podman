# OSINT Agent - Podman Compatible Version
FROM python:3.11-slim

# Install system dependencies and OSINT tools
RUN apt-get update && apt-get install -y \
    # Basic utilities
    curl wget git unzip build-essential \
    # Network tools
    nmap masscan dnsutils whois netcat-traditional traceroute \
    # SSL/TLS tools  
    openssl \
    # Text processing
    jq xmlstarlet \
    # Version control
    git \
    # Go language for Go-based tools
    golang-go \
    # Python build dependencies
    python3-dev python3-pip \
    # Podman for container operations
    podman \
    # Additional useful tools
    sqlite3 \
    && rm -rf /var/lib/apt/lists/*

# Set Go environment
ENV GOPATH=/opt/go
ENV PATH=$PATH:/opt/go/bin:/usr/local/go/bin

# Create workspace and user
RUN mkdir -p /workspace /app /opt/go
WORKDIR /app

# Configure Podman for rootless operation
RUN mkdir -p /etc/containers
COPY <<EOF /etc/containers/storage.conf
[storage]
driver = "overlay"
runroot = "/run/containers/storage"
graphroot = "/var/lib/containers/storage"

[storage.options]
additionalimagestores = [
]

[storage.options.overlay]
mountopt = "nodev,metacopy=on"
EOF

# Copy requirements and install Python packages
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Skip Go tools for now to avoid build issues - can be installed at runtime

# Install theHarvester via pip
RUN pip install theHarvester

# Install Shodan CLI
RUN pip install shodan

# Install additional Python OSINT libraries
RUN pip install \
    python-whois \
    censys \
    shodan \
    selenium \
    beautifulsoup4 \
    scrapy \
    requests-html \
    fake-useragent

# Copy application source
COPY src/ ./src/

# Make main script executable
RUN chmod +x src/main.py

# Create log directory
RUN mkdir -p /var/log/osint

# Set Python path
ENV PYTHONPATH=/app/src

# Configure container runtime
ENV CONTAINER_RUNTIME=podman

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD python -c "import sys; sys.exit(0)"

# Default command
CMD ["python", "src/main.py"]

# Labels for documentation
LABEL description="Autonomous OSINT Investigation Agent for IRC (Podman Compatible)"
LABEL version="1.0.0-podman"
LABEL tools="maigret,nmap,subfinder,nuclei,theharvester,shodan"